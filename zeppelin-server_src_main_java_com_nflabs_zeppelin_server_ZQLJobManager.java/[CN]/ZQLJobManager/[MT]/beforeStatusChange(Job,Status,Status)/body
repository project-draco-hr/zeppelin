{
  try {
    if (after == Status.ERROR && job.getException() != null) {
      logger.error("Job error",job.getException());
    }
    logger.info("Job " + job.getId() + " status changed from "+ before+ " to "+ after);
    ZQLJob jobToSave=((ZQLJob)job).clone();
    jobToSave.setListener(null);
    jobToSave.setStatus(after);
    persist(jobToSave);
    if (after == Status.FINISHED) {
      makeHistory(jobToSave.getId());
      persist(jobToSave);
    }
  }
 catch (  IOException e) {
    logger.error("Can't persist job " + job.getId(),e);
  }
}
