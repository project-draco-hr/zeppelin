{
  ScriptEngine engine=getRubyScriptEngine();
  StringBuffer rubyScript=new StringBuffer();
  SimpleBindings bindings=new SimpleBindings();
  engine.setBindings(bindings,ScriptContext.ENGINE_SCOPE);
  rubyScript.append("require 'erb'\n");
  String query=super.getQuery();
  bindings.put(Q.PREV_VAR_NAME,query);
  rubyScript.append(Q.PREV_VAR_NAME + "=$" + Q.PREV_VAR_NAME+ "\n");
  bindings.put("params",params);
  rubyScript.append("params = {}\n");
  rubyScript.append("$params.each{|key,value|params[key]=value}\n");
  try {
    FSDataInputStream ins=fs.open(erbFile);
    BufferedReader br=new BufferedReader(new InputStreamReader(ins));
    String line=null;
    rubyScript.append("erb = \"\"\n");
    while ((line=br.readLine()) != null) {
      rubyScript.append("erb += \"" + line + "\"\n");
    }
    ins.close();
  }
 catch (  IOException e1) {
    throw new ZException(e1);
  }
  rubyScript.append("$e = ERB.new(erb).result(binding)\n");
  try {
    logger.info("rubyScript to run : \n" + rubyScript.toString());
    engine.eval(rubyScript.toString(),bindings);
  }
 catch (  ScriptException e) {
    throw new ZException(e);
  }
  return (String)engine.getBindings(ScriptContext.ENGINE_SCOPE).get("e");
}
