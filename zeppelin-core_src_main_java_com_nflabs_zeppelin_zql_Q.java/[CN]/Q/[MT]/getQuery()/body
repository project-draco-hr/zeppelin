{
  if (prev() == null) {
    return query;
  }
 else   if (query == null) {
    return prev().getQuery();
  }
 else {
    String prevQuery=prev().getQuery();
    Matcher m=templatePattern.matcher(query);
    if (m.matches()) {
      return query.replaceAll("[$][{]" + PREV_VAR_NAME + "[}]",prevQuery.replaceAll("\\$","\\\\\\$").trim());
    }
 else {
      return query + " " + prevQuery;
    }
  }
}
