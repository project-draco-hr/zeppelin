{
  final String paragraphId=(String)fromMessage.get("id");
  if (paragraphId == null) {
    return;
  }
  final Note note=notebook.getNote(getOpenNoteId(conn));
  Paragraph p=note.getParagraph(paragraphId);
  String text=(String)fromMessage.get("paragraph");
  p.setText(text);
  p.setTitle((String)fromMessage.get("title"));
  Map<String,Object> params=(Map<String,Object>)fromMessage.get("params");
  p.settings.setParams(params);
  Map<String,Object> config=(Map<String,Object>)fromMessage.get("config");
  p.setConfig(config);
  if (text != null && text.length() > 0 && note.getLastParagraph().getId().equals(p.getId())) {
    note.addParagraph();
    broadcastNote(note.id(),new Message(OP.NOTE).put("note",note));
  }
  note.persist();
  broadcastNote(note.id(),new Message(OP.NOTE).put("note",note));
  note.run(paragraphId);
}
